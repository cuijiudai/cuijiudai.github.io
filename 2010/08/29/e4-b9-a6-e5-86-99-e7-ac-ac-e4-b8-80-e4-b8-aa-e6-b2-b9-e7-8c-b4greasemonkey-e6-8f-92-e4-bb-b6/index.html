<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>书写第一个油猴(Greasemonkey)插件 | 美拓blog | 做个有趣的人</title>

  
  <meta name="author" content="独孤逸辰">
  

  
  <meta name="description" content="互联网开发者，金融爱好者,关注农业民生。">
  

  
  
  <meta name="keywords" content="油猴">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="书写第一个油猴(Greasemonkey)插件"/>

  <meta property="og:site_name" content="美拓blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="美拓blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">美拓blog</a>
    </h1>
    <p class="site-description">做个有趣的人</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
        <li><a href="/about">关于</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article >

  
    
    <h3 class="article-title"><span>书写第一个油猴(Greasemonkey)插件</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2010/08/29/e4-b9-a6-e5-86-99-e7-ac-ac-e4-b8-80-e4-b8-aa-e6-b2-b9-e7-8c-b4greasemonkey-e6-8f-92-e4-bb-b6/" rel="bookmark">
        <time class="entry-date published" datetime="2010-08-29T03:41:45.000Z">
          2010-08-29
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <div><br><br><img src="http://blog.meituo.net/wp-content/uploads/Greasemonkey/Greasemonkey.png" alt="油猴"><br><br>### 油猴插件简介<br><br><em>Greasemonkey</em>是<a href="http://blog.meituo.net/zh-cn/Mozilla_Firefox" title="Mozilla Firefox" target="_blank" rel="external">Mozilla Firefox</a>的一个附加组件。它让用户安装一些<a href="http://blog.meituo.net/zh-cn/%E8%85%B3%E6%9C%AC%E8%AA%9E%E8%A8%80" title="脚本语言" target="_blank" rel="external">脚本</a>使大部分HTML为主的<a href="http://blog.meituo.net/zh-cn/%E7%B6%B2%E9%A0%81" title="网页" target="_blank" rel="external">网页</a>于用户端直接改变得更方便易用。随着Greasemonkey脚本常驻于浏览器，每次随着目的网页打开而自动做修改，使得运行脚本的用户印象深刻地享受其固定便利性。<br><br><a id="more"></a><br><br>大部分Greasemonkey用户脚本都是自行撰写，使用对某网站专用的<a href="http://blog.meituo.net/zh-cn/JavaScript" title="JavaScript" target="_blank" rel="external">JavaScript</a>代码，通过<a href="http://blog.meituo.net/zh-cn/%E6%96%87%E6%A1%A3%E5%AF%B9%E8%B1%A1%E6%A8%A1%E5%9E%8B" title="文档对象模型" target="_blank" rel="external">文档对象模型</a>（DOM）接口对网页内容做操作。<a href="http://userscripts.org/" target="_blank" rel="external">userscripts.org</a>维护了个 Greasemonkey 数据库。该数据库描述哪个<a href="http://blog.meituo.net/zh-cn/URL" title="URL" target="_blank" rel="external">网址</a>网页对应到哪个脚本。<br><br>当用户加载匹配的网页，Greasemonkey便调用相关的脚本，而该脚本便根据脚本内容改变网页的内容。Greasemonkey脚本亦能通过非网域绑定的<a href="http://blog.meituo.net/zh-cn/XMLHTTP" title="XMLHTTP" target="_blank" rel="external">XMLHTTP</a>要求来查询外部HTTP资源。Greasemonkey亦遵循某用户名.user.js的格式，这让当该特定用户拜访时 Greasemonkey 可自动侦测并提供安装选项。除了JavaScript代码，Greasemonkey脚本包括有限可选用后数据集。该后数据集描述了脚本名称、脚本描述、网址用来区分同名脚本的地址空间、以及原本该脚本为哪些网址撰写的列表。<br><br>油猴官方网站：<a href="http://www.greasespot.net/" target="_blank" rel="external">http://www.greasespot.net/ </a><br><br>Firefox的油猴插件安装地址：<a href="https://addons.mozilla.org/firefox/748/" target="_blank" rel="external">https://addons.mozilla.org/firefox/748/ </a><br><br>油猴平台脚本库：<a href="http://userscripts.org/" target="_blank" rel="external">http://userscripts.org/</a><br><br>Firefox用户请先安装<a href="https://addons.mozilla.org/firefox/748/" target="_blank" rel="external">油猴插件：</a>。<br><br>更多可见:<a href="http://zh.wikipedia.org/zh-cn/%E6%B2%B9%E7%8C%B4" target="_blank" rel="external">油猴的维基百科</a><br><br>### 用户脚本<br><br>用户脚本（user script）就是一个js 文件，也就是我们要写插件，他通常是xxx.user.js,xxx是文件名，且必须由user.js结尾，当你将脚本拖拽到火狐进行安装时，油猴将自动检测到此文件为油猴插件，弹出安装窗口。<br><br>这是名为hello world脚本的安装<br><br><img src="http://blog.meituo.net/wp-content/uploads/Greasemonkey/hello_world_install.png" alt="插件安装窗口"><br><br>### 使用metadata来描述你的插件<br><br>每一个插件都有一个metadata区域来告诉油猴关于这个插件的信息，如：插件的来源（@namespace）和插件何时运行（@include）。<br><br>#### eg. hello world metadata<br><br><pre><br>// ==UserScript==<br>// @name          Hello World<br>// @namespace     <a href="http://blog.meituo.net/projects/greasemonkey/" target="_blank" rel="external">http://blog.meituo.net/projects/greasemonkey/</a><br>// @description   example script to alert “Hello world!” on every page<br>// @include       <em><br>// @exclude       <a href="http://blog.meituo.net/" target="_blank" rel="external">http://blog.meituo.net/</a></em><br>// @exclude       <a href="http://www.meito.22web.net/*" target="_blank" rel="external">http://www.meito.22web.net/*</a><br>// ==/UserScript==<br></pre><br><br>这里metadata有六条独立的条目，包裹在一组特定 Greasemonkey 的注释（Greasemonkey-specific comments）里，让我们按顺序介绍一下，从注释包裹开始<br><br><pre><br>// ==UserScript==<br><br>// ==/UserScript==<br></pre><br><br>这个注释块很重要，而且要严格匹配（成对出现）油猴使用它们来标记metadata的开始和结束，这个注释块可以放在在脚本的任何地方，但是通常放在靠近开头的位置。<br><br>#### @name<br><br>在metadata内，第一项是name.<br><br><pre>// @name          Hello World<br></pre><br><br>这是插件的名称，当你安装插件时会在安装窗口看到，安装后在 “管理用户脚本” 窗口也可以看到，名字嘛当然要精简，有概况性。<br><br>@name 是可选的，也就是可以不用为插件起名字。如果存在，它可能只出现一次。如果不存在，它将默认为用户的脚本文件名减去 .user.js。<br><br>#### @namespace<br><br>下一项是 namespace。<br><br><pre>// @namespace     <a href="http://blog.meituo.net/projects/greasemonkey/" target="_blank" rel="external">http://blog.meituo.net/projects/greasemonkey/</a><br></pre><br><br>这一项是网址（URL），油猴使用它来区分拥有相同名称但是由不同的开发人员书写的插件，如果你有域名（或者二级域名的等），你可以用它作为namespace，或者你可以使用<a href="http://taguri.org/" target="_blank" rel="external">tag: URI </a>(此链接已坏).<br><br>@namespace 也是可选项，如果存在，它可能只出现一次。如果不存在，它将默认为用户的下载该脚本文件的网址。<br><br><strong>tip:<br><br>    你可以使用任意的顺序来书写这些metadata项，我喜欢使用这样的顺序：@name 、@namespace 、@description 、@include 和@exclude ，当然你可以按照自己的方式。

</strong><br><br>#### @description<br><br><pre>// @description   example script to alert “Hello world!” on every page<br></pre><br><br>这是为了更可读（human-readable），当你安装插件时会在安装窗口看到，安装后在 “管理用户脚本” 窗口也可以看到。其不应长于两句话。<br><br> @description 也是可选项，如果存在，它可能只出现一次。如果不存在，默认为空。<br><br> <strong>impotant:<br><br>    不要忘记写@description ，即使是为你自己书写脚本，你最终或许会有很多，如果你不书写的话在“管理用户脚本” 窗口将难以管理这些插件。

</strong><br><br>下一项是是最重要的一项（Greasemonkey 的角度来看），也就是@include 和@exclude URLs<br><br>#### @include 和@exclude<br><br><pre>// @include       <em><br>// @exclude       <a href="http://blog.meituo.net/" target="_blank" rel="external">http://blog.meituo.net/</a></em><br>// @exclude       <a href="http://www.meito.22web.net/*" target="_blank" rel="external">http://www.meito.22web.net/*</a><br></pre><br><br>这一项告知油猴在哪个网站你想使用这个脚本，两者都使用指定一个的 URL，<em> 作为域的名称或路径的一部分的简单通配符字符。 在这种情况下我们告诉Greasemonkey <a href="http://blog.meituo.net/及http://www.meito.22web.net/" target="_blank" rel="external">http://blog.meituo.net/及http://www.meito.22web.net/</a> 除外的所有站点上执行 Hello World 脚本。 exclude优先级高于include，这样即使 <a href="http://blog.meituo.net/download/" target="_blank" rel="external">http://blog.meituo.net/download/</a> 匹配 </em> （所有站点），因为它也匹配 <a href="http://blog.meituo.net/*" target="_blank" rel="external">http://blog.meituo.net/*</a> ，所以<a href="http://blog.meituo.net/download/" target="_blank" rel="external">http://blog.meituo.net/download/</a> 将被排除。<br><br>@include 和@exclude 也是可选的，你可以书写任意多的@include 和@exclude 的URLs，但是你必须将每一个url写在单独的一行，如果两项都没有写明，油猴将在所有的站点使用这个脚本。（效果等同于 // @include <em> ）<br><br> <strong>impotant:<br><br>对于@include 和@exclude 你需要使用非常清晰的网址，油猴不会对 用户认为相同的网址（URLs）进行任何的联想假设（assumptions），如：如果你想在<a href="http://example.com/" target="_blank" rel="external">http://example.com/</a> 和 <a href="http://www.example.com/" target="_blank" rel="external">http://www.example.com/</a> 同时使用脚本，必须两个都要声明。

</strong><br><br>###  书写脚本<br><br>我们的第一个脚本执行时 将简单的弹出 “hello world”。<br><br><pre>alert(“hello world!”);<br></pre><br><br>虽然代码看起来明显足够，执行也完全符合预期，但在幕后 Greasemonkey 其实做很多事情来确保 用户脚本（user scripts）不与页面中的js发生冲突，它自动将 用户脚本封装到一个匿名函数里，通常你可以忽略这一点，但是它最终会给你制造大麻烦，因此现在您也可能学习一下。<br><br>例如，该用户脚本定义了一个函数的HelloWorld，然后尝试设置一个计时器在一秒钟后来调用它。<br><br>#### eg:延迟执行一个函数的错误方法<br><br><pre><br>function helloworld(){<br>    alert(“hello world!”);<br>}<br>window.setTimeout(“helloworld”,60);<br></pre><br><br>这将不会工作，不会弹出窗口，如果你打开JavaScript 控制台，你会发现一个异常，Error: helloworld is not defined. 这是因为通过计时器的执行hellowworld()时helloworld函数已经不存在了<br><br>如果你想后来使用你用户脚本中的变量和函数，您将需要显式地将它们定义为始终可用的window对象的属性。<br><br>#### eg:更好的延迟执行函数的方法<br><br><pre><br>window.helloworld =function(){<br>    alert(“hello world!”);<br>}<br>window.setTimeout(“helloworld”,60);<br></pre><br><br>这个代码得到了预期的效果，页面加载后一秒弹出窗口“hello world！”。<br><br>然而将属性加到 window 上也不是一个好选择，这样就有点像本地脚本的全局变量（事实上，它是完全一样的，因为window 是全局的并可以被页面上的所有脚本访问），更实际上，他最终可能会和页面上的脚本冲突或者和别的“用户脚本”冲突。<br><br>最好的解决方法就是 你自己定义一个匿名函数并且将它最好的解决办法是定义一个匿名函数，并将它作为window.setTimeout的第一个参数。<br><br>#### eg:最好的 延迟执行函数的方法<br><br><pre><br>window.setTimeout(function(){alert(“hello world!”)},60);<br></pre><br><br>我这里做的就是创建了一个匿名函数，并将它作为setTimeout的第一个参数，这样和我们上例一样的结果，但是没有留下隐患，它对其他脚本是不可见的。<br><br>我在书写用户脚本时通常使用匿名函数。 他们是适合创建”一次性“函数，将它们作为参数传递给 window.setTimeout ，document.addEventListener，或将分配给事件处理程序，如单击或提交。<br><br><em>现在最常用的写法是将将代码写进一个自动执行的闭包：

</em><br><br><pre><br>(functon(){<br>//code goes here<br>})()<br></pre><br><br>###  编辑用户脚本<br><br>对用户脚本作者来说，“管理用户脚本” 窗口有一个好处就是可以随时动态的修改脚本。<br><br><strong><br><br>当你在“管理用户脚本”窗口编辑代码事，实际上你是在动态的编辑位于火狐 profile 目录下脚本的副本，我有一个习惯就是每次我完成一个脚本的动态测试，就保存一份。

</strong><br><br>那么最终我们的脚本helloworld.user.js为：<br><br><pre><br>// ==UserScript==<br>// @name          Hello World<br>// @namespace     <a href="http://blog.meituo.net/projects/greasemonkey/" target="_blank" rel="external">http://blog.meituo.net/projects/greasemonkey/</a><br>// @description   example script to alert “Hello world!” on every page<br>// @include       </pre></em><br>// @exclude       <a href="http://blog.meituo.net/*" target="_blank" rel="external">http://blog.meituo.net/*</a><br>// @exclude       <a href="http://www.meito.22web.net/*" target="_blank" rel="external">http://www.meito.22web.net/*</a><br>// ==/UserScript==<br>alert(‘Hello world!’);<br><br><br>当然我们可以添加一些跟多的信息和介绍<br><br><pre><br>// Hello World! example user script<br>// version 0.1 BETA!<br>// 2005-04-25<br>// Copyright (c) 2005, Mark Pilgrim<br>// Released under the GPL license<br>// <a href="http://www.gnu.org/copyleft/gpl.html" target="_blank" rel="external">http://www.gnu.org/copyleft/gpl.html</a><br>// ——————————————————————–<br>//<br>// This is a Greasemonkey user script.  To install it, you need<br>// Greasemonkey 0.3 or later: <a href="http://greasemonkey.mozdev.org/" target="_blank" rel="external">http://greasemonkey.mozdev.org/</a><br>// Then restart Firefox and revisit this script.<br>// Under Tools, there will be a new menu item to “Install User Script”.<br>// Accept the default configuration and install.<br>//<br>// To uninstall, go to Tools/Manage User Scripts,<br>// select “Hello World”, and click Uninstall.<br>//<br>// ——————————————————————–<br>// ==UserScript==<br>// @name          Hello World<br>// @namespace     <a href="http://blog.meituo.net/projects/greasemonkey/" target="_blank" rel="external">http://blog.meituo.net/projects/greasemonkey/</a><br>// @description   example script to alert “Hello world!” on every page<br>// @include       <em><br>// @exclude       <a href="http://blog.meituo.net/" target="_blank" rel="external">http://blog.meituo.net/</a></em><br>// @exclude       <a href="http://www.meito.22web.net/*" target="_blank" rel="external">http://www.meito.22web.net/*</a><br>// ==/UserScript==<br>alert(‘Hello world!’);<br></pre><br><div><a href="http://diveintogreasemonkey.org/download/book/diveintogreasemonkey-pdf-2005-05-09.zip" target="_blank" rel="external">下载pdf教程</a><a href="http://blog.meituo.net/diveintogreasemonkey-html-2005-05-09" target="_blank" rel="external">下载HTML教程</a></div></div>
      
    </div>
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/浏览器/">浏览器</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/油猴/">油猴</a>
    </span>
    

    </div>

    
  </div>
</article>

  




    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2016 独孤逸辰
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>
