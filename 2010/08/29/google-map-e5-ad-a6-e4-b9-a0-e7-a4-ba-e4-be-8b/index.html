<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>google map学习示例 | 美拓blog | 做个有趣的人</title>

  
  <meta name="author" content="独孤逸辰">
  

  
  <meta name="description" content="互联网开发者，金融爱好者,关注农业民生。">
  

  
  
  <meta name="keywords" content="google map">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="google map学习示例"/>

  <meta property="og:site_name" content="美拓blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="美拓blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">美拓blog</a>
    </h1>
    <p class="site-description">做个有趣的人</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/about">About</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article >

  
    
    <h3 class="article-title"><span>google map学习示例</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2010/08/29/google-map-e5-ad-a6-e4-b9-a0-e7-a4-ba-e4-be-8b/" rel="bookmark">
        <time class="entry-date published" datetime="2010-08-29T03:47:56.000Z">
          2010-08-29
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <div><br><br>工作了一个多星期了，公司有一个前端，那就是我，对，只有我一个，自己面向对象不是怎么好，看到真么长（如下）的js类看懂就不错了，别说写了，这是好租网的google map 的一个类，是用prototype写的，<del>自己有一个地方没看懂那就是当marker不在当前视图时是如何从地图上删除的？要命没找到，在getJsonMarkers类里没看到对此的操作，有高人给指点一下，不胜感激。</del><ins>我找到了，mapMarkers存储的是引用。</ins><a href="http://code.google.com/intl/zh-CN/apis/maps/documentation/reference.html" target="_blank" rel="external">google 的函数</a>解释晦涩难懂啊仅仅google官方的例子没发现类此的。<br><br>如果有google开发的资料可以发给我，呵呵，不胜感激，我的qq邮箱。cuijiudai@qq.com<br><br><a id="more"></a><br><br>#### 好租的 map 操作类<br><br><pre><br>//地图部分<br>APF.Namespace.register(“HaoZu.Map”);<br>HaoZu.Map.Findding = Class.create({<br>    initialize: function(E, B) {<br>        //E盛放地图信息的容器<br>        this.cavanId = E;<br>        this.cavansElement = $(E);<br>        //存放地图<br>        this.canvas = this.cavansElement.select(“#” + E + “_map2_canvas2”).first();<br>        //存放 鼠标指到markers后出现的小区名字<br>        this.commname = this.cavansElement.select(“.map2_commname”).first();<br>        //propwind：点击markers后出现的窗口<br>        this.propwind = this.cavansElement.select(“.map2_propwind”).first();<br>        //proparrow：点击markers后出现的窗口的小箭头<br>        this.proparrow = this.cavansElement.select(“.map2_proparrow”).first();<br>        //propwind_commname：存放 鼠标点击markers后 出现的小区名字<br>        this.propwind_commname = this.propwind.select(“.map2_propwind_commname”).first();<br>        //map2_propwind_listlink :全部房源 的链接<br>        this.propwind_listlink = this.propwind.select(“.map2_propwind_listlink”).first();<br>       // loupanWind：正在加载<br>        this.loupanWind = this.cavansElement.select(“.map2_loupan”).first();<br>        var A = this.cavansElement.select(“.qmtype_normal”).first();<br>        var D = this.cavansElement.select(“.qmtype_hybrid”).first();<br>        var C = this.cavansElement.select(“.map_proptotal”).first();<br>        this.getCanvasDimension();<br>        this.DEF_CITY_INFO = B.cityInfo;<br>        //过滤条件<br>        this.filter = B.filter;<br>        //弹出窗口的高宽<br>        this.DEF_PROP_WINDOW_HEIGHT = 280;<br>        this.DEF_PROP_WINDOW_WIDTH = 250;<br>        this.DEF_LOUPAN_WINDOW_HEIGHT = 280;<br>        this.DEF_LOUPAN_WINDOW_WIDTH = 250;<br>        this.DEF_LEFT_LIMIT = 380;<br>        this.DEF_ARROW_WIDTH = 7;<br>        this.keyword = “”;<br>        //prototype  的hash对象，在此类中用于存储markers<br>        this.mapMarkers = new Hash();<br>        this.pwPage = 1;<br>        this.filter.source = this.DEF_CITY_INFO.typeid;<br>        this.cavansElement.select(“.map2_propwind_close”).each(function(F) {<br>            F.observe(“click”,<br>            function() {<br>                this.hidePropWind()<br>            }.bind(this))<br>        }.bind(this));<br>        //下一页<br>        this.propwind.select(“.page_next”).first().observe(“click”,<br>        function() {<br>            this.propPage += 1;<br>            this.updatePropWind(this.propCommId, this.propPage, this.propOrder)<br>        }.bind(this));<br>        //上一页<br>        this.propwind.select(“.page_prev”).first().observe(“click”,<br>        function() {<br>            this.propPage -= 1;<br>            if (this.propPage == 0) {<br>                this.propPage = 1<br>            }<br>            this.updatePropWind(this.propCommId, this.propPage, this.propOrder)<br>        }.bind(this));<br>        //排序方式的 select<br>        this.propWindOrder = this.propwind.select(“.map2_propwind_order”).first();<br>        this.propWindOrder.observe(“change”,<br>        function() {<br>            this.propOrder = this.propWindOrder.value;<br>            this.updatePropWind(this.propCommId, this.propPage, this.propOrder)<br>        }.bind(this));<br><br>        document.observe(“map:pan”,<br>        function(F) {<br>            this.map.panTo(new GLatLng(F.memo.lat, F.memo.lng))<br>        }.bind(this));<br><br>        document.observe(“map:zoom”,<br>            function(F) {<br>                this.map.setZoom(F.memo.zoom)<br>            }.bind(this));<br><br>        document.observe(“filter:price”,<br>            function(F) {<br>                this.filter.price = F.memo.price;<br>                this.filter.lp = F.memo.lp;<br>                this.filter.up = F.memo.up;<br>                this.hidePropWind();<br>                this.getJsonMarkers()<br>            }.bind(this));<br>        document.observe(“filter:room”,<br>        function(F) {<br>            this.filter.room = F.memo.room;<br>            this.hidePropWind();<br>            this.getJsonMarkers()<br>        }.bind(this));<br>        document.observe(“filter:deploy”,<br>        function(F) {<br>            this.filter.deploy = F.memo.deploy;<br>            this.hidePropWind();<br>            this.getJsonMarkers()<br>        }.bind(this));<br>        document.observe(“filter:source”,<br>        function(F) {<br>            this.filter.source = F.memo.source;<br>            $(“apf_list_swtich”).value = F.memo.source;<br>            this.hidePropWind();<br>            this.getJsonMarkers()<br>        }.bind(this));<br>        document.observe(“filter:date”,<br>        function(F) {<br>            this.filter.date = F.memo.date;<br>            this.hidePropWind();<br>            this.getJsonMarkers()<br>        }.bind(this));<br>        document.observe(“filter:renttype”,<br>        function(F) {<br>            this.filter.renttype = F.memo.renttype;<br>            this.hidePropWind();<br>            this.getJsonMarkers()<br>        }.bind(this));<br>        document.observe(“map:type”,<br>        function(F) {<br>            if (F.memo.type == “normal”) {<br>                this.map.setMapType(G_NORMAL_MAP)<br>            } else {<br>                if (F.memo.type == “hybrid”) {<br>                    this.map.setMapType(G_HYBRID_MAP)<br>                }<br>            }<br>        }.bind(this));<br>        document.observe(“map:geo”,<br>        function(G) {<br>            var F = G.memo.keyword;<br>            this.getGeo(F)<br>        }.bind(this));<br>        D.observe(“click”,<br>        function() {<br>            document.fire(“map:type”, {<br>                type: “hybrid”<br>            })<br>        });<br>        A.observe(“click”,<br>        function() {<br>            document.fire(“map:type”, {<br>                type: “normal”<br>            })<br>        });<br>        document.observe(“tip:loading”,<br>        function() {<br>            C.update(“正在为您找房子，请稍后……”)<br>        });<br>        document.observe(“tip:finished”,<br>        function(H) {<br>            var F = H.memo.num;<br>            if (F == 0) {<br>                var G = “没找到符合您要求的房子，缩小地图试试看吧”<br>            } else {<br>                if (F &lt; 50) {<br>                    var G = “在这里找到了” + F + “个小区”<br>                } else {<br>                    var G = “找到了超过50个小区，放大地图能看到更多”<br>                }<br>            }<br>            C.update(G)<br>        }.bind(this))<br>       // alert(“zhixing”)<br>    },<br>    //A 是城市内的区县<br>    //在设置了城市后，获得<br>    getGeo: function(A) {<br>        //如果没有设置范围 ，则设置视窗为城市<br>        if (this.geocoder == undefined) {<br>            //此类用于和 Google 服务器建立直接通信，以获取用户指定地址的地址解析<br>            this.geocoder = new GClientGeocoder();<br>            //取得城市的矩形范围<br>            this.searchBound = new GLatLngBounds(new GLatLng(this.DEF_CITY_INFO.swlat, this.DEF_CITY_INFO.swlng), new GLatLng(this.DEF_CITY_INFO.nelat, this.DEF_CITY_INFO.nelng));<br>            //setViewport设置地址解析器以便在指定的视口内或附近放大地址解析结果。<br>            //尽管设置视口会提升结果优先级，但不会将结果限制到该边界框内。<br>            this.geocoder.setViewport(this.searchBound)<br>        }<br>        this.geocoder.getLatLng(A,<br>        function(B) { //B是服务器 取到的A的GLatLng<br>            //containsLatLng当且仅当该点的地理坐标位于此矩形内时，返回 true。<br>            if (B &amp;amp;amp;&amp;amp;amp; this.searchBound.containsLatLng(B)) {<br>                this.searchPoint = B;<br>                this.map.panTo(B);<br>                if (this.searchMarker == undefined) {<br>                    //GMarker 标记地图上的位置。它实现 GOverlay接口<br>                    this.searchMarker = new GMarker(B);<br>                    this.map.addOverlay(this.searchMarker)<br>                } else {<br>                    this.searchMarker.setLatLng(B);//设置此标记的锚定点的地理坐标。<br>                }<br>                this.searchMarker.openInfoWindowHtml(A)<br>            } else {<br>                alert(this.DEF_CITY_INFO.name + “找不到这个地方:” + A)<br>            }<br>        }.bind(this))<br>    },<br>    //取得地图范围<br>    getCanvasDimension: function() {<br>        //prototype 的方法getDimensions() -&gt; {height: Number, width: Number}<br>        this.canvasDimension = this.canvas.getDimensions()<br>    },<br>    //创建地图<br>    drawMap: function() {<br>        this.map = new GMap2(this.canvas);<br>        //A城市中心<br>        var A = new GLatLng(this.DEF_CITY_INFO.lat, this.DEF_CITY_INFO.lng);<br>        this.map.setCenter(A, this.DEF_CITY_INFO.zoom);<br>        this.getBounds();<br>         // getPane 返回层中包含 pane 识别的对象的 DIV, G_MAP_MARKER_PANE 该窗格包含标记前景图。<br>        this.markerPanel = this.map.getPane(G_MAP_MARKER_PANE);<br>        this.map.enableScrollWheelZoom();<br>        this.map.addControl(new GLargeMapControl());<br>        G_NORMAL_MAP.getMinimumResolution = function() {<br>            return 9<br>        };<br>        G_NORMAL_MAP.getMaximumResolution = function() {<br>            return 19<br>        };<br>        G_HYBRID_MAP.getMinimumResolution = function() {<br>            return 9<br>        };<br>        G_HYBRID_MAP.getMaximumResolution = function() {<br>            return 19<br>        };<br>        //放大结束<br>        GEvent.addListener(this.map, “zoomend”,<br>        function() {<br>            window.clearTimeout(this.timeoutHandle);<br>            this.hideCommName();<br>            this.hidePropWind();<br>            this.removeMapMarkers();<br>            this.doTrack({<br>                linkTrackVars: “events”,<br>                linkTrackEvents: “event8”,<br>                events: “event8”,<br>                pVar: “zoom”<br>            })<br>        }.bind(this));<br>        //移动开始时 隐藏提示，窗口<br>        GEvent.addListener(this.map, “movestart”,<br>        function() {<br>            window.clearTimeout(this.timeoutHandle);<br>            this.hidePropWind();<br>            this.hideCommName();<br>            this.hideNotice()<br>        }.bind(this));<br>        //移动地图时 取得地图范围，重绘地图<br>        GEvent.addListener(this.map, “moveend”,<br>        function() {<br>            this.timeoutHandle = window.setTimeout(function() {<br>                this.getBounds();<br>                this.getJsonMarkers()<br>            }.bind(this), 800)<br>        }.bind(this))<br>    },<br>    //取得地图范围<br>    getBounds: function() {<br>        var E = 80;<br>        var G = this.map.fromContainerPixelToLatLng(new GPoint(E, E / 2));<br>        var D = this.map.fromContainerPixelToLatLng(new GPoint(this.canvasDimension.width - E / 2, this.canvasDimension.height - E / 2));<br>        var B = D.lat().toFixed(3);<br>        var A = G.lat().toFixed(3);<br>        var F = G.lng().toFixed(3);<br>        var C = D.lng().toFixed(3);<br>        this.bounds = {<br>            slatFrom: B,<br>            slatTo: A,<br>            slngFrom: F,<br>            slngTo: C<br>        }<br>    },<br><br>    //创建标记(返回marker)，并绑定事件<br>    buildMarker: function(C, B, E, D) {<br>        var A = $(document.createElement(“div”));<br>        A.update(“&lt;strong&gt;” + C + “&lt;/strong&gt; 套”);<br>        A.className = “marker”;<br>        A.writeAttribute(“propNum”, C);<br>        Event.observe(A, “mouseover”,<br>        function() {<br>            A.className = “marker marker_hover”;<br>            var F = this.map.fromLatLngToContainerPixel(E);<br>            this.showCommName(B, F.y, F.x)<br>        }.bind(this));<br>        Event.observe(A, “mouseout”,<br>        function() {<br>            A.className = “marker”;<br>            this.hideCommName()<br>        }.bind(this));<br>        Event.observe(A, “click”,<br>        function() {<br>            var F = this.map.fromLatLngToContainerPixel(E);<br>            this.showPropWind(F.y, F.x, D, B);<br>            this.doTrack({<br>                linkTrackVars: “events”,<br>                linkTrackEvents: “event10”,<br>                events: “event10”,<br>                pVar: “click”<br>            })<br>        }.bind(this));<br>        return A<br>    },<br>    //将标记添加到地图<br>    drawMarker: function(marker, y , x) {<br>        //添加到地图<br>        Element.insert(this.markerPanel, marker);<br>        //设置位置<br>        marker.setStyle({<br>            top:y - 40 + “px”,<br>            left: x + “px”,<br>            display: “block”<br>        })<br>    },<br>    //显示正在加载窗口<br>    showLoupanWindow: function(C, B, D, A) {<br>        this.showInfoWindow(C, B);<br>        this.updateLoupanWind(D, A)<br>    },<br>    //点击mark、时弹出的窗口； E:y ,D:x<br>    showInfoWindow: function(E, D) {<br>        // 显示箭头<br>        this.showWindArrow(E, D);<br>        //windowW :弹出窗口WIDTH；  windowH :弹出窗口HEIGHT<br>        var windowW = this.DEF_PROP_WINDOW_WIDTH;<br>        var windowH = this.DEF_PROP_WINDOW_HEIGHT;<br><br>        var Y = E - 40;<br>        //处理地图下部点击 y的坐标<br>        if ((Y + F) &gt; this.canvasDimension.height) {<br>            Y = this.canvasDimension.height - windowH<br>        }<br>        var X = D;<br>        //如果在左方 定位<br>        if (X &lt; this.DEF_LEFT_LIMIT) {<br>            X = D + this.DEF_ARROW_WIDTH<br>        } else {//默认显示在点击点的左方<br>            X = D - this.DEF_ARROW_WIDTH - windowW<br>        }<br>        this.propwind.setStyle({<br>            top: Y + “px”,<br>            left: X + “px”,<br>            display: “block”<br>        })<br>    },<br>    //hover时出现小区名字<br>    showCommName: function(A, C, B) {<br>        this.commname.update(A);<br>        this.commname.setStyle({<br>            top: C - 40 + “px”,<br>            left: B + 43 + “px”,<br>            display: “block”<br>        })<br>    },<br>    hideCommName: function() {<br>        this.commname.setStyle({<br>            display: “none”<br>        })<br>    },<br>    //显示点击mark后的窗口的箭头<br>    showWindArrow: function(Y, X) {<br>        if (X &lt; this.DEF_LEFT_LIMIT) {//  窗口在右边显示<br>            this.proparrow.className = “map2_proparrow map2_proparrow_right”;<br>            windowLeft = X<br>        } else {//窗口在左边显示的时候<br>            this.proparrow.className = “map2_proparrow map2_proparrow_left”;<br>            windowLeft = X - this.DEF_ARROW_WIDTH - 1<br>        }<br>        this.proparrow.setStyle({<br>            top: Y - 7 + “px”,<br>            left: windowLeft + “px”,<br>            display: “block”<br>        })<br>    },<br>    //显示点击marker后弹出窗口  A 小区名字  xiaoquID<br>    showPropWind: function(Y, X, xiaoquID, name) {<br>        //设置默认排序 方式<br>        this.setFilter(this.propWindOrder, 0);<br>        //显示箭头<br>        this.showWindArrow(Y, X);<br>        //小区名字<br>        this.propwind_commname.update(name);<br>         //小区链接<br>        this.propwind_commname.href = “/compound/W0QQcZ” + xiaoquID;<br>        if ($F(“apf_list_swtich”) == 1) {//如果只有一个结果就链接到这个房源的详细信息<br>            this.propwind_listlink.href = “/compound/landlord/W0QQcZ” + xiaoquID<br>        } else {//如果有多个房源就链接到房源的列表<br>            this.propwind_listlink.href = “/compound/broker/W0QQcZ” + xiaoquID<br>        }<br>        //弹出窗口的Id为小区的id<br>        this.propCommId = xiaoquID;<br>        this.propPage = 1;<br>        this.propOrder = 0;<br>        this.updatePropWind(this.propCommId, this.propPage, this.propOrder);<br>        //显示窗口<br>        this.showInfoWindow(Y, X)<br>    },<br>    //隐藏窗口<br>    hidePropWind: function() {<br>        this.proparrow.setStyle({<br>            display: “none”<br>        });<br>        this.propwind.setStyle({<br>            display: “none”<br>        });<br>        this.loupanWind.setStyle({<br>            display: “none”<br>        })<br>    },<br>    //刷新弹出窗口内容 id  小区id<br>    updatePropWind: function(id, page, order) {<br>        this.showLoading();<br>        var url = this.buildListUrl(id, page, order);<br>        new Ajax.Request(url, {<br>            method: “get”,<br>            onSuccess: function(response) {<br>                this.drawPropBox(response.responseJSON)<br>            }.bind(this)<br>        })<br>    },<br>    //构造 弹出窗口；B是json<br>    drawPropBox: function(B) {<br>        if (this.propBoxes == undefined) {<br>            //table 的tr集合<br>            this.propBoxes = this.propwind.select(“.prop_box”);<br>            this.propPrices = this.propwind.select(“.prop_price”);<br>            this.propRooms = this.propwind.select(“.prop_room”);<br>            //tr的链接地址<br>            this.propHrefs = this.propwind.select(“.prop_href”);<br>            this.propTypes = this.propwind.select(“.prop_type”);<br>            this.propDates = this.propwind.select(“.prop_date”);<br>            this.propImgs = this.propwind.select(“.prop_img”);<br>            this.propNum = this.cavansElement.select(“.prop_num”).first();<br>            this.propBoxes.each(function(F) {<br>                F.observe(“mouseover”,<br>                function() {<br>                    F.setStyle({<br>                        backgroundColor: “#e2f6ff”<br>                    })<br>                });<br>                F.observe(“mouseout”,<br>                function() {<br>                    F.setStyle({<br>                        backgroundColor: “white”<br>                    })<br>                })<br>            })<br>        }<br>        //json的第一个数据是符合本窗口 条件的 总房源个数<br>        this.propNum.update(B[0]);<br>        var D = B[1];<br>        var A = this.propBoxes.length;<br>        for (var C = 0; C &lt; A; C++) {<br>            var E = null;<br>            if (D[C] != null) {<br>                E = D[C]<br>            }<br>            if (E != undefined &amp;amp;amp;&amp;amp;amp; E != null) {<br>                this.propBoxes[C].setStyle({<br>                    display: “block”<br>                });<br>                this.propPrices[C].update(E.pricenum + “元”);<br>                this.propRooms[C].update(E.roomnum + “室”);<br>                this.propHrefs[C].setAttribute(“href”, E.href);<br>                this.propTypes[C].update(E.renttype);<br>                this.propDates[C].update(E.date);<br>                if (parseInt(E.ishigh) == 1) {<br>                    this.propImgs[C].update(“多图”)<br>                } else {<br>                    if (parseInt(E.imagesnum) &gt; 0) {<br>                        this.propImgs[C].update(“图”)<br>                    } else {<br>                        this.propImgs[C].update(“”)<br>                    }<br>                }<br>            } else {<br>                this.propBoxes[C].setStyle({<br>                    display: “none”<br>                })<br>            }<br>        }<br>        this.hideLoading()<br>    },<br>    //点击marker弹出窗口 的正在加载<br>    showLoading: function() {<br>        if (this.propwindTable == undefined) {<br>            this.propwindLoad = this.propwind.select(“.map2_propwind_load”).first();<br>            this.propwindTable = this.propwind.select(“.map2_propwind_table”).first();<br>            this.propwindNumber = this.propwind.select(“.map2_propwind_numbinfo”).first()<br>        }<br>        this.propwindLoad.show();<br>        this.propwindTable.hide();<br>        this.propwindNumber.hide()<br>    },<br>    hideLoading: function() {<br>        this.propwindLoad.hide();<br>        this.propwindTable.show();<br>        this.propwindNumber.show()<br>    },<br>    //显示楼盘 正在加载<br>    showLoupanLoading: function() {<br>        if (this.loupanContent == undefined) {<br>            this.loupanContent = this.loupanWind.select(“.map2_loupan_content”).first();<br>            this.loupanLoad = this.loupanWind.select(“.map2_loupanwind_load”).first()<br>        }<br>        this.loupanContent.hide();<br>        this.loupanLoad.show()<br>    },<br>    //  隐藏楼盘 正在加载<br>    hideLoupanLoading: function() {<br>        this.loupanContent.show();<br>        this.loupanLoad.hide()<br>    },<br>    getJsonMarkers: function() {<br>        document.fire(“tip:loading”);<br>        this.hideNotice();<br>        //生成参数网址<br>        var url= this.buildUrl(0, 1, 0);<br>        new Ajax.Request(url, {<br>            method: “get”,<br>            onSuccess: function(H) {<br>                var backJSON = H.responseJSON;<br>                // backJSON为返回对象； backJSON 为{“76242”:[“\u82f9\u679c\u793e\u533a”,1493,39.8979339,116.4686823],<br>                // “55419”:[“\u540e\u73b0\u4ee3\u57ce”,1452,39.8998929,116.4878225] ……}<br>                // 类似的对象<br><br>                //把 obj 当作一个 Hash，然后返回该对象的属性名称列表。<br>                //Object.keys({ name: ‘Prototype’, version: 1.5 }).sort()<br>                // -&gt; [‘name’, ‘version’]<br>                //E为返回的id列表数组<br>                var idlist = Object.keys(backJSON);<br>                var B = idlist.length;<br>                //B搜索到的结果数<br>                document.fire(“tip:finished”, {<br>                    num: B<br>                });<br>                //如果没有返回 数据<br>                if (B == 0) {<br>                    this.removeMapMarkers();<br>                    this.hideCommName();<br>                    //如果还没有弹出窗口就创建<br>                    if (this.notice == undefined) {<br>                        this.notice = this.cavansElement.select(“.map2_notice”).first();<br>                        var button = this.notice.select(“.l4”).first();<br>                        button.observe(“click”,<br>                        function() {<br>                            this.hideNotice()<br>                        }.bind(this))<br>                    }<br>                    //减去窗口宽度 除以2，实现窗口居中<br>                    var G = (this.canvasDimension.width - 360) / 2;<br>                    this.notice.setStyle({<br>                        display: “block”,<br>                        left: G + “px”<br>                    })<br>                } else {<br>                    //如果返回数据 过滤不在视图中的小区<br>                    this.mapMarkers.each(function(J) {<br>                        var I = backJSON[J.key];<br>                        //去除新的里面没有       或者新旧两者同一小区的房源数目不同的<br>                        if (I == undefined || I[1] != J.value.readAttribute(“propNum”)) {<br>                            this.mapMarkers.get(J.key).remove();<br>                            this.mapMarkers.unset(J.key)<br>                        }<br>                    }.bind(this));<br>                    var timer = 0;<br>                    idlist.each(function(id) {<br>                        //找到mapMarkers内没有存储的marker，添加到地图和mapMarkders，所以地图每次都只是在原来的基础上绘制没有的marker。<br>                        if (this.mapMarkers.get(id) == undefined) {<br>                            window.setTimeout(function() {<br>                                //K为backJSON的每个对象成员<br>                                var K = backJSON[id];<br>                                //创建坐标<br>                                var point = new GLatLng(K[2], K[3]);<br>                                //K[1]套数，K[0]小区名字，point 是GPoint，id是小区编号<br>                                //J  是单个的marker对象<br>                                var newmarker= this.buildMarker(K[1], K[0], point, id);<br>                                //point 是地理坐标对象,L是转化后的点；<br>                                var L = this.map.fromLatLngToDivPixel(point);<br>                                //绘制marker<br>                                this.drawMarker(newmarker, L.y, L.x);<br>                                //添加到mapMarkers<br>                                this.mapMarkers.set(id, newmarker)<br>                            }.bind(this), timer++*30)<br>                        }<br>                    }.bind(this))<br>                }<br>            }.bind(this)<br>        })<br>    },<br><br>    //清空mapMarkers的全部内容<br>    removeMapMarkers: function() {<br>        this.mapMarkers.each(function(A) {<br>            this.mapMarkers.get(A.key).remove();<br>            this.mapMarkers.unset(A.key)<br>        }.bind(this))<br>    },<br>    //地图放大，拖拽的url构造<br>    buildUrl: function(D, E, B) {<br>        var A = $H({<br>            p3: this.bounds.slatFrom,<br>            p4: this.bounds.slatTo,<br>            p5: this.bounds.slngFrom,<br>            p6: this.bounds.slngTo,<br>            p9: this.filter.price,<br>            p10: this.filter.renttype,<br>            p11: this.filter.room,<br>            p12: this.filter.date,<br>            p13: this.filter.source,<br>            p14: this.filter.deploy,<br>            p15: this.filter.lp,<br>            p16: this.filter.up<br>        }).toQueryString();<br>        var C = “/map/search?” + A;<br>        return C<br>    },<br>    //构造 弹出窗口的房源列表的条件查询url<br>    buildListUrl: function(id, page, order) {<br>        var A = $H({<br>            p1: id,<br>            p2: page,<br>            p3: order,<br>            p9: this.filter.price,<br>            p10: this.filter.renttype,<br>            p11: this.filter.room,<br>            p12: this.filter.date,<br>            p13: this.filter.source,<br>            p14: this.filter.deploy,<br>            p15: this.filter.lp,<br>            p16: this.filter.up<br>        }).toQueryString();<br>        var C = “/map/prolist/?” + A;<br>        return C<br>    },<br><br>    //检测下拉列表value 是否包含b，包含则设置选中第B个option<br>    setFilter: function(A, B) {<br>        if (A == undefined) {<br>            return<br>        }<br>        for (i = 0; i &lt; A.options.length; i++) {<br>            if (parseInt(A.options[i].value) == parseInt(B)) {<br>                A.options[i].selected = true;<br>                break<br>            }<br>        }<br>    },<br>    //隐藏没有房源的 弹出窗口信息<br>    hideNotice: function() {<br>        if (this.notice != undefined) {<br>            this.notice.setStyle({<br>                display: “none”<br>            })<br>        }<br>    },<br>    //将消息以纯文本形式写入日志窗口。对 HTML 标记字符进行转义，使其成为可见字符。<br>    wlog: function(A) {<br>        GLog.write(A)<br>    },<br>    //插件用于trace<br>    doTrack: function(B) {<br>        if (typeof s_account == “undefined”) {<br>            return<br>        }<br>        var A = s_gi(s_account);<br>        if (B.linkTrackVars) {<br>            A.linkTrackVars = B.linkTrackVars<br>        }<br>        if (B.linkTrackEvents) {<br>            A.linkTrackEvents = B.linkTrackEvents<br>        }<br>        if (B.eVar13) {<br>            A.eVar13 = B.eVar13<br>        }<br>        if (B.events) {<br>            A.events = B.events<br>        }<br>        A.tl(this, “o”, B.pVar)<br>    }<br>});<br></pre></div>
      
    </div>
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/JavaScript/">JavaScript</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/google-map/">google map</a>
    </span>
    

    </div>

    
  </div>
</article>

  




    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2016 独孤逸辰
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>
